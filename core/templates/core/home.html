<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SocialHub - Home</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}" />
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: #f0f2f5;
        }
        .navbar {
            background: linear-gradient(90deg, #1877f2, #3b5998);
        }
        .post img {
            max-height: 400px;
            object-fit: cover;
        }
        .avatar {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
        }
        .like-btn.liked i {
            color: #ff0000;
        }
        
        /* Modal Styles */
        #commentsModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        #commentsModal.active {
            opacity: 1;
            visibility: visible;
        }
        
        #commentsModal > div {
            background: white;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        #modalCommentsList {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        #modalCommentForm {
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 0.5rem;
        }
        
        #modalCommentInput {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }
        
        #closeCommentsModal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        
        #closeCommentsModal:hover {
            color: #111827;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
</head>
<body class="min-h-screen">
    <nav class="navbar p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <a href="{% url 'home' %}" class="text-white text-2xl font-bold">SocialHub</a>
            <div class="space-x-4">
                <a href="{% url 'home' %}" class="text-white hover:text-gray-200 transition">Home</a>
                <a href="{% url 'profile' %}" class="text-white hover:text-gray-200 transition">Profile</a>
                <a href="{% url 'settings' %}" class="text-white hover:text-gray-200 transition">Settings</a>
                {% if user.is_authenticated %}
                    <a href="{% url 'logout' %}" class="text-white hover:text-gray-200 transition">Logout</a>
                {% else %}
                    <a href="{% url 'login' %}" class="text-white hover:text-gray-200 transition">Login</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-6 max-w-2xl">
        {% if user.is_authenticated %}
            {% with user_setting=user.setting %}
                <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                    <button id="createPostBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition flex items-center justify-center">
                        <i class="fas fa-pen mr-2"></i> What's on your mind?
                    </button>
                    <form id="postForm" class="mt-4 hidden" enctype="multipart/form-data" method="POST" action="/api/posts/">
                        {% csrf_token %}
                        <textarea id="postText" name="body" placeholder="Write your post here..." required class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        <div class="flex items-center space-x-4 mt-3">
                            <input type="file" id="postImage" name="image" accept="image/*" class="flex-1" />
                            <select name="privacy" class="p-2 border rounded-lg">
                                <option value="public" {% if user_setting.post_privacy == 'public' %}selected{% endif %}>Public</option>
                                <option value="friend" {% if user_setting.post_privacy == 'friend' %}selected{% endif %}>Friends</option>
                                <option value="private" {% if user_setting.post_privacy == 'private' %}selected{% endif %}>Private</option>
                            </select>
                        </div>
                        <button type="submit" class="mt-3 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">Post</button>
                    </form>
                </div>
            {% endwith %}
        {% else %}
            <p class="text-center text-gray-600 mb-6">Please <a href="{% url 'login' %}" class="text-blue-600 hover:underline">log in</a> to create a post.</p>
        {% endif %}

        <div id="postsContainer">
            {% for item in posts %}
                <div class="post bg-white rounded-lg shadow-md p-4 mb-6" data-post-id="{{ item.post.id }}">
                    <div class="meta flex items-center mb-3">
                        {% if item.post.user.profile.avatar %}
                            <img src="{{ item.post.user.profile.avatar.url }}" alt="Avatar" class="avatar mr-2" />
                        {% else %}
                            <i class="fas fa-user-circle text-gray-400 mr-2 text-2xl"></i>
                        {% endif %}
                        <div>
                            <span class="username text-blue-600 font-semibold">{{ item.post.user.f_name }} {{ item.post.user.l_name }}</span>
                            <div class="text-gray-500 text-sm">{{ item.post.created_at|date:"m/d/Y H:i" }}</div>
                        </div>
                    </div>
                    <p class="text-gray-800 mb-3">{{ item.post.body }}</p>
                    {% if item.post.image %}
                        <img src="{{ item.post.image.url }}" alt="Post image" class="w-full rounded-lg mb-3" />
                    {% endif %}
                    <div class="flex items-center space-x-4 mb-3">
                        <button class="like-btn {% if item.is_liked %}liked{% endif %}" data-post-id="{{ item.post.id }}">
                            <i class="fas fa-heart"></i> <span class="like-count">{{ item.post.postreact_set.count }}</span> Likes
                        </button>

                        <button class="comments-btn text-blue-600 hover:underline" data-post-id="{{ item.post.id }}">
                            {{ item.post.comment_set.count }} Comments
                        </button>
                    </div>
                </div>
            {% empty %}
                <p class="text-center text-gray-600">No public posts available.</p>
            {% endfor %}
        </div>
    </div>

    <!-- Comments Modal -->
    <div id="commentsModal">
        <div class="relative">
            <button id="closeCommentsModal" aria-label="Close modal">&times;</button>
            <h3 class="text-xl font-semibold p-4 border-b">Comments</h3>
            
            <div id="modalCommentsList" class="p-4">
                <!-- Comments will be loaded here -->
            </div>

            {% if user.is_authenticated %}
            <form id="modalCommentForm" class="p-4">
                {% csrf_token %}
                <div class="flex gap-2 w-full">
                    <input type="text" id="modalCommentInput" name="body" placeholder="Write a comment..." required
                        class="flex-1 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" />  <!-- استخدمنا flex-1 بدلاً من w-full -->
                    <button type="submit"
                        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        Comment
                    </button>
                </div>
            </form>
            </div>
            </form>
            {% else %}
            <div class="p-4 border-t">
                <p class="text-gray-500">Please <a href="{% url 'login' %}" class="text-blue-600 hover:underline">log in</a> to comment.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Show/hide post form
        const createPostBtn = document.getElementById('createPostBtn');
        const postForm = document.getElementById('postForm');
        if (createPostBtn && postForm) {
            createPostBtn.addEventListener('click', () => {
                postForm.classList.toggle('hidden');
                createPostBtn.classList.toggle('hidden');
            });
        }

        // Handle post form submission
        if (postForm) {
            postForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(postForm);
                const token = document.querySelector('input[name=csrfmiddlewaretoken]').value;
                
                try {
                    const response = await fetch('/api/posts/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': token,
                        },
                        body: formData,
                    });
                    
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        const error = await response.json().catch(() => ({ detail: 'Failed to create post' }));
                        alert(error.detail || 'Failed to create post');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while creating the post.');
                }
            });
        }

        // Like button functionality
        document.querySelectorAll('.like-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const postId = this.getAttribute('data-post-id');
                const token = document.querySelector('input[name=csrfmiddlewaretoken]').value;
                
                try {
                    const response = await fetch(`/api/posts/${postId}/toggle_like/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': token,
                        },
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.classList.toggle('liked', data.liked);
                        this.querySelector('.like-count').textContent = data.like_count;
                    } else {
                        alert('Failed to update like status');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while updating like status');
                }
            });
        });

        // Comments modal functionality
        const commentsModal = document.getElementById('commentsModal');
        const modalCommentsList = document.getElementById('modalCommentsList');
        const modalCommentForm = document.getElementById('modalCommentForm');
        const modalCommentInput = document.getElementById('modalCommentInput');
        const closeBtn = document.getElementById('closeCommentsModal');
        
        let currentPostId = null;

        // Open modal when clicking comments button
        document.querySelectorAll('.comments-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                currentPostId = this.getAttribute('data-post-id');
                commentsModal.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                // Load comments
                try {
                    modalCommentsList.innerHTML = '<p class="text-center py-4">Loading comments...</p>';
                    const response = await fetch(`/api/posts/${currentPostId}/comments/`);
                    
                    if (response.ok) {
                        const comments = await response.json();
                        
                        if (comments.length === 0) {
                            modalCommentsList.innerHTML = '<p class="text-center text-gray-500 py-4">No comments yet</p>';
                        } else {
                            modalCommentsList.innerHTML = comments.map(comment => `
                                <div class="mb-4 pb-4 border-b border-gray-100">
                                    <div class="flex items-start mb-2">
                                        ${comment.user.profile?.avatar ? 
                                            `<img src="${comment.user.profile.avatar.url}" class="w-8 h-8 rounded-full mr-2" alt="User avatar">` : 
                                            `<i class="fas fa-user-circle text-gray-400 text-2xl mr-2"></i>`
                                        }
                                        <div>
                                            <strong class="text-sm">${comment.user.f_name} ${comment.user.l_name}</strong>
                                            <p class="text-gray-700 mt-1">${comment.body}</p>
                                            <small class="text-xs text-gray-400">${new Date(comment.created_at).toLocaleString()}</small>
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                        }
                    } else {
                        modalCommentsList.innerHTML = '<p class="text-center text-red-500 py-4">Failed to load comments</p>';
                    }
                } catch (error) {
                    console.error('Error loading comments:', error);
                    modalCommentsList.innerHTML = '<p class="text-center text-red-500 py-4">Error loading comments</p>';
                }
            });
        });

        // Close modal
        function closeModal() {
            commentsModal.classList.remove('active');
            document.body.style.overflow = '';
            modalCommentsList.innerHTML = '';
            if (modalCommentInput) modalCommentInput.value = '';
            currentPostId = null;
        }

        // Close button
        if (closeBtn) {
            closeBtn.addEventListener('click', closeModal);
        }

        // Close when clicking outside modal
        commentsModal.addEventListener('click', (e) => {
            if (e.target === commentsModal) {
                closeModal();
            }
        });

        // Close with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && commentsModal.classList.contains('active')) {
                closeModal();
            }
        });

        // Handle comment submission
        if (modalCommentForm) {
            modalCommentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!currentPostId || !modalCommentInput.value.trim()) return;
                
                const token = modalCommentForm.querySelector('input[name=csrfmiddlewaretoken]').value;
                
                try {
                    const response = await fetch(`/api/posts/${currentPostId}/comments/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': token,
                        },
                        body: JSON.stringify({ body: modalCommentInput.value.trim() }),
                    });
                    
                    if (response.ok) {
                        const newComment = await response.json();
                        
                        const commentHtml = `
                            <div class="mb-4 pb-4 border-b border-gray-100">
                                <div class="flex items-start mb-2">
                                    ${newComment.user.profile?.avatar ? 
                                        `<img src="${newComment.user.profile.avatar.url}" class="w-8 h-8 rounded-full mr-2" alt="User avatar">` : 
                                        `<i class="fas fa-user-circle text-gray-400 text-2xl mr-2"></i>`
                                    }
                                    <div>
                                        <strong class="text-sm">${newComment.user.f_name} ${newComment.user.l_name}</strong>
                                        <p class="text-gray-700 mt-1">${newComment.body}</p>
                                        <small class="text-xs text-gray-400">${new Date(newComment.created_at).toLocaleString()}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        if (modalCommentsList.firstChild?.classList?.contains('text-gray-500')) {
                            modalCommentsList.innerHTML = commentHtml;
                        } else {
                            modalCommentsList.insertAdjacentHTML('afterbegin', commentHtml);
                        }
                        
                        modalCommentInput.value = '';
                    } else {
                        const error = await response.json().catch(() => ({ detail: 'Failed to post comment' }));
                        alert(error.detail || 'Failed to post comment');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while posting the comment');
                }
            });
        }
    });
    </script>
</body>
</html>